<!DOCTYPE html>
<html lang="en">

{% load suponoff %}
{% load staticfiles %}

  <head>
	<meta charset="utf-8"/>

	{% block title %}
	<title>Supervisor On/Off</title>
	{% endblock title %}
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="//gitcdn.github.io/bootstrap-toggle/2.0.0/css/bootstrap-toggle.min.css">

	<style>

	div.box {
		float: left;
		border: 1px solid;
		border-radius:10px;
		background-color: #eee;
		padding: 10px;
		margin: 10px;
		background: linear-gradient(#fff, #ccd);
		box-shadow: 5px 5px 5px #aaa;
	}

  div.box h3 {
    margin-top: 0;
  }

	.box .bg-success {
		background: #00FF00;
	}
	.box .bg-warning {
		background: #FFFF00;
	}
	.box .bg-danger {
		background: #FF5930;
	}

	div.server {
		float: left;
		border: 1px solid;
		border-radius:10px;
		background-color: #eee;
		padding: 10px;
		margin: 10px;
		background: linear-gradient(#fff, #ccd);
		box-shadow: 5px 5px 5px #aaa;
	}
	div.group {
		float: left;
		border:2px solid;
		border-radius:5px;
		padding: 4px;
		margin: 4px;
		background: #eee;
	}

	div.program {
		float: left;
		border: 1px solid;
		padding: 4px;
		margin: 4px;
		display: none;
		background: #ffffff;
	}

	.program-description {
		font-style: oblique;
		font-family: mono;
	}

	#show-logs-dialog pre {
		overflow: auto;
		word-break: normal !important;
		word-wrap: normal !important;
		white-space: pre !important;
	}

	.jqstooltip {
		width: 150px;
		height: 25px !important;
    }

	.server .bg-success {
		background: #00FF00;
	}
	.server .bg-warning {
		background: #FFFF00;
	}
	.server .bg-danger {
		background: #FF5930;
	}

	#page-loading {
		background: url("{% static 'suponoff/ajax-loader.gif'%}") no-repeat scroll center center;
		position: absolute;
		height: 100%;
		width: 100%;
	}

	</style>

	{% block extra_head %}
	{% endblock extra_head %}

  </head>


  <body>

  	{% block body %}

  	{% block content %}

  <table id="tags_control">
    <tr>
      <th>Groups</th>
      <th>Filters</th>
    </tr>
  </table>

	<div class="clearfix" style="clear:both; margin: 10px">
		Mode: <input id="tag-filter-mode" type="checkbox" data-toggle="toggle"
		             data-on="AND" data-off="OR">
		<a id="tag-filter-all" href="#">[all]</a>
		<a id="tag-filter-none" href="#">[none]</a>
	</div>

	{% for server, groups in nowhere %}

	<div class="server" id="server-{{server}}" data-server-name="{{ server }}">
	  <h3>Server: <a href="http://{{ server }}:9001">{{ server }}</a>
		<div style="float: right">
		  <button type="button" class="btn btn-success btn-xs startall"
		          data-loading-text="Starting all programs..."
		          onclick="on_startall_clicked(this)"
		          >
		          Start All
		  </button>
		  <button type="button" class="btn btn-danger btn-xs stopall"
		          data-loading-text="Stopping all programs..."
		          onclick="on_stopall_clicked(this)"
		          >
		          Stop All
		   </button>
		</div>

	  </h3>

	  {% for group_name, group in groups %}

	    <div id="group-{{group_name}}" class="group" data-group-name="{{ group_name }}"
	         data-tags="{{group.tags|join:' '}}"
	    >
		  <h4>
			<span class="group-name">{{ group_name }}</span>
			{% if group.total_processes > 1 %}
			<small>(<span class="num-processes-running"></span> / {{group.total_processes}} running)</small>
			{% endif %}
			<button type="button" class="btn btn-default btn-xs group_details_toggle">Details</button>
		  </h4>

		  {% if group.tags %}
		  <div style="margin-bottom: 6px">
		  {% for tag in group.tags %}
		    <span class="badge">{{tag}}</span>
		  {% endfor %}
		  </div>
		  {% endif %}

		  {% for program in group.processes %}
	      <div id="process-{{program.name}}" class="program"
	           data-program-name="{{ program.name }}"
	           data-pid="{{ program.pid }}"
	        >
			<h5>{{ program.name }}: <span class="program-state"></span></h5>
			<span class="program-description">{{program.description}}</span>
			<button class="btn btn-xs" onclick="open_stdout(this)">stdout</button>
			<button class="btn btn-xs" onclick="open_stderr(this)">stderr</button>
			<button class="btn btn-xs applog" onclick="open_applog(this)"
			        title="Opens the application log file `{{program.application_logfile}}'."
			        >
			        applog
			</button>
		    <br>
			<h6 class="resources-heading" style="display: none">Resources:</h6>

			{# Open files #}
			<div class="resource fileno" style="display: none">
			  File descriptors: <span class="textual-value"></span>
			  <br/>
			  <div class="progress" style="margin-bottom: 2px; display: none">
				<div class="progress-bar" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="">
				</div>
			  </div>
			</div>


			{# VM size #}
			<div class="resource vmsize" style="display: none">
			  VM size: <span class="textual-value"></span>
			  <br/>
			  <div class="progress" style="margin-bottom: 2px; display: none">
				<div class="progress-bar" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="">
				</div>
			  </div>
			</div>

			{# numthreds #}
			<div class="resource numthreads" style="display: none">
			  Threads: <span class="numthreads">?</span>
			</div>

			{# numchildren #}
			<div class="resource numchildren" style="display: none">
			  Child processes: <span class="numchildren">?</span>
			</div>

			{# cpu #}
			<div class="resource cpu" style="width=100%; height: 32px; line-height: 32px;">
			  <div style="display: inline-block; height: 24px; vertical-align: bottom">CPU (%):&nbsp;</div><div style="display: inline-block; height: 32px; vertical-align: bottom" class="sparkline">...</div>
			</div>

			{# Disk IO #}
			<div class="resource diskio" style="width=100%; height: 32px; line-height: 32px;">
			  <div style="display: inline-block; height: 24px; vertical-align: bottom">Disk I/O (kB/s):&nbsp;</div><div style="display: inline-block; height: 32px; vertical-align: bottom" class="sparkline">...</div>
			</div>

			{% if group.total_processes > 1 %}
		    <br>
			<div class="clearfix" style="clear:both;">
			  <button type="button" class="btn btn-primary" data-loading-text="Starting..." onclick="on_program_start_clicked(this)">Start</button>
			  <button type="button" class="btn btn-primary" data-loading-text="Restarting..." onclick="on_program_restart_clicked(this)">Restart</button>
			  <button type="button" class="btn btn-primary" data-loading-text="Stopping..." onclick="on_program_stop_clicked(this)">Stop</button>
			</div>
			{% endif %}

		  </div>
		  {% endfor %} {# programs loop #}
		  <div class="clearfix" style="clear:both;">
			<button type="button" class="btn btn-primary" data-loading-text="Starting..." onclick="on_group_start_clicked(this)">Start</button>
			<button type="button" class="btn btn-primary" data-loading-text="Restarting..." onclick="on_group_restart_clicked(this)">Restart</button>
			<button type="button" class="btn btn-primary" data-loading-text="Stopping..." onclick="on_group_stop_clicked(this)">Stop</button>
		  </div>
		</div> {# group #}

		{% endfor %}  {# groups loop #}

	</div> {# closes server #}

	{% endfor %}  {# servers loop #}

  	{% endblock content %}

  <div id="rootbox"></div>

  <div id="protos" style="display:none">

    <div class="box procgroup">
      <h3><span class="attname"></span>: <span class="attvalue"></span>
        <div style="float: right">
          <button type="button" class="btn btn-info btn-xs btn-expand"
            >Expand</button>
          <button type="button" class="btn btn-success btn-xs btn-startall"
            >Start All</button>
          <button type="button" class="btn btn-danger btn-xs btn-stopall"
            >Stop All</button>
        </div>
      </h3>
      <div class="children" style="display:none"></div>
    </div>

    <div class="box process">
      <h3><span class="name"></span>
        <div style="float: right">
          <button type="button" class="btn btn-success btn-xs btn-start"
            >Start</button>
          <button type="button" class="btn btn-danger btn-xs btn-stop"
            >Stop</button>
        </div>
      </h3>
      <div class="procdata">
        <div class="supervisor">Supervisor: <span class="value"></span></div>
      </div>
    </div>

    <table>
      <tr class="tags_group">
        <td data-toggle="buttons">
          <label class="btn btn-primary taggroup">
            <input type="checkbox" class="group"/>
            <span class="taggroup-label">taggroup</span>
          </label>
        </td>
        <td>
          <div class="tag-toggles" style="margin: 2px">
            <div class="taggroup btn-group" data-toggle="buttons">
            </div>
          </div>
        </td>
      </tr>
    </table>

    <label class="btn btn-primary tag">
      <input type="checkbox" class="filter" data-tag="tag" />
      <span class="tag-label">tag</span>
    </label>

    <div class="supervisor" /*id="sup-NAME"*/ /*data-name="NAME" */>
      <h3>Server: <a class="url" href="#"></a>
      <div style="float: right">
        <button type="button" class="btn btn-success btn-xs startall"
                data-loading-text="Starting all programs..."
                onclick="on_startall_clicked(this)"
                >
                Start All
        </button>
        <button type="button" class="btn btn-danger btn-xs stopall"
                data-loading-text="Stopping all programs..."
                onclick="on_stopall_clicked(this)"
                >
                Stop All
         </button>
      </div>
      </h3>
      <div class="groups"></div>
    </div>
  </div>

	<div class="modal fade" id="show-logs-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-lg">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h4 class="modal-title" id="myModalLabel">Modal title</h4>
		  </div>
		  <div class="modal-body"><pre></pre>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		  </div>
		</div>
	  </div>
	</div>


	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
	<script src="//gitcdn.github.io/bootstrap-toggle/2.0.0/js/bootstrap-toggle.min.js"></script>

	<script src="{% static "suponoff/suponoff.js" %}"></script>

  	{% endblock body %}

  <script>
    var data = {{data|safe}};
    processes = data2procs(data);

    axes = [];

    function filter_processes(procsin) {
      var filters = $('#tags_control input.filter').filter(function () {
        return $(this).prop('checked');
      });

      if (!filters.length) {
        return procsin;
      }

      var mode_and = (!! $('#tag-filter-mode').prop('checked'));
      var procsout = [];
      $(procsin).each(function () {
        var proc = this;
        var should_add = mode_and;
        filters.each(function () {
          var filter = $(this);
          pval = proc[filter.data('attr-name')] + '';
          fval = filter.data('attr-value') + '';
          if (mode_and) {
            if (fval != pval) should_add = false;
          }
          else {
            if (fval == pval) should_add = true;
          }
        });

        if (should_add) {
          procsout.push(proc);
        }
      });

      return procsout;
    }

    function render_box(process, target, axes) {
      var attr, val, cls;
      if (axes.length) {
        var attr = axes[0];
        var val = process[attr] + '';   // the string "undefined" if none
        var cls = 'attr-' + attr + '-' + val;
        var box = target.find('.' + cls).first();
        if (!box.length) {
          var box = $('#protos .procgroup').clone().addClass(cls);
          box.find('.attname').text(attr);
          box.find('.attvalue').text(val);
          box.data('attvalue', val);
          insert_box_inplace(box, target);
        }
        render_box(process, box.find('.children').first(), axes.slice(1));
      } else {
        var box = $('#protos .process').clone();
        render_process(process, box);
        insert_box_inplace(box, target);
      }
    }

    function insert_box_inplace(box, target) {
      // Find the place to insert to keep them in order
      var cc = target.children();
      var ins = false;
      for (var i = 0, ii = (cc.length); i < ii; i++) {
        var ch = $(cc[i]);
        if (box.data('attvalue') < ch.data('attvalue')) {
          ch.before(box);
          ins = true;
          break;
        }
      }
      if (!ins) {
        target.append(box);
      }
    }

    function render_process(process, box) {
      var val = process.supervisor + '-' + process.process;
      box.parent().data('process', process);
      box.find('.name').text(process.process);
      box.data('attvalue', val);
      box.find('.supervisor .value').text(process.supervisor);
    }

    function collapse_single(box) {
      var children = box.children('.children').children('.box');
      if (children.length == 1) {
        var child = children.detach();
        box.replaceWith(children);
        box = children;
        collapse_single(box);
      }
      else {
        box.children('.children').children('.box').each(
          function() { collapse_single($(this)); });
      }
    }

    function render_boxes(axes) {
      var root = $('#rootbox');
      root.empty();

      var procs = filter_processes(processes);
      $(procs).each(function() {
        render_box(this, root, axes);
      });

      root.children('.box').each(
        function () { collapse_single($(this)); });
    }

    function render_tags_controls() {
      var got_axes = collect_axes(processes);
      $(got_axes).each(function () {
        var attrname = this.label;
        var tr = $('#protos .tags_group').clone().appendTo('#tags_control');
        tr.find('.taggroup-label').text(attrname);
        tr.find('input').data('attr-name', attrname);
        $(this.values).each(function () {
          var attrval = this;
          var btn = $('#protos label.tag').clone()
            .appendTo(tr.find('div.taggroup'));
          btn.find('span.tag-label').text(attrval);
          btn.children('input')
            .data('attr-name', attrname)
            .data('attr-value', attrval);
        });
      });
    }

    $(document).ready(function() {
      $('#rootbox').on("click", ".btn-expand", function() {
        var box = $(this).parents('.box').first()
        box.find('.children').first().toggle();
        var btn = box.find('.btn-expand').first();
        btn.text(btn.text() == 'Expand' && 'Collapse' || 'Expand');
      });

      $('#tags_control').on("toggle", "input.group", function() {
        var name = $(this).data('attr-name');
        if ($(this).prop('checked')) {
          axes.push(name);
        } else {
          axes.splice(axes.indexOf(name), 1);
        }
        render_boxes(axes);
      });

      $('#tags_control').on("change", "input.group", function() {
        var name = $(this).data('attr-name');
        if ($(this).prop('checked')) {
          axes.push(name);
        } else {
          axes.splice(axes.indexOf(name), 1);
        }
        render_boxes(axes);
      });

      $('#tags_control').on("change", "input.filter", function() {
        render_boxes(axes);
      });

      $('#tag-filter-mode').on("change", function() {
        render_boxes(axes);
      });

      $('#tag-filter-all').on("click", function() {
        $('#tags_control input.filter').prop('checked', true);
        $('#tags_control label.tag').addClass('active');
        render_boxes(axes);
      });

      $('#tag-filter-none').on("click", function() {
        $('#tags_control input.filter').prop('checked', false);
        $('#tags_control label.tag').removeClass('active');
        render_boxes(axes);
      });

      render_tags_controls();
      render_boxes(axes);
    });
  </script>

  </body>

</html>
